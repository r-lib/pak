#' Clean up pak caches
#'
#' @param package_cache Whether to clean up the cache of package files.
#' @param metadata_cache Whether to clean up the cache of package meta
#'   data.
#' @param pak_lib This argument is now deprecated and does nothing.
#' @param force Do not ask for confirmation. Note that to use this function
#'   in non-interactive mode, you have to specify `force = TRUE`.
#'
#' @export
#' @family pak housekeeping

pak_cleanup <- function(package_cache = TRUE, metadata_cache = TRUE,
                        pak_lib = TRUE, force = FALSE) {
  if (!force && !interactive()) {
    stop("Refused to clean up, please specify `force = TRUE`")
  }

  if (package_cache) pak_cleanup_package_cache(force)
  if (metadata_cache) pak_cleanup_metadata_cache(force)

  invisible()
}

pak_cleanup_package_cache <- function(force) {
  load_all_private()
  sum <- pkg_data[["ns"]][["pkgcache"]][["pkg_cache_summary"]]()
  if (!force) {
    size <- format_bytes$pretty_bytes(sum$size)
    pkg_data[["ns"]][["cli"]][["cli_alert"]](
      "{.emph Package cache} is in {.path {sum$cachepath}} ({size})"
    )
    force <- get_confirmation2("? Do you want to remove it? (Y/n) ")
  }

  if (force) {
    unlink(sum$cachepath, recursive = TRUE)
    root <- sum$cachepath
    if (length(dir(root)) == 0) unlink(root, recursive = TRUE)
    pkg_data[["ns"]][["cli"]][["cli_alert_success"]](
      "Cleaned up package cache"
    )
  }
  invisible(force)
}

pak_cleanup_metadata_cache <- function(force) {
  load_all_private()
  sum <- pkg_data[["ns"]][["pkgcache"]][["meta_cache_summary"]]()
  if (!force) {
    size <- format_bytes$pretty_bytes(sum$size)
    pkg_data[["ns"]][["cli"]][["cli_alert"]](
      "{.emph Metadata cache} is in {.path {sum$cachepath}} ({size})"
    )
    force <- get_confirmation2("? Do you want to remove it? (Y/n) ")
  }

  if (force) {
    unlink(sum$cachepath, recursive = TRUE)
    unlink(sum$lockfile, recursive = TRUE)
    root <- dirname(sum$cachepath)
    if (length(dir(root)) == 0) unlink(root, recursive = TRUE)
    pkg_data[["ns"]][["cli"]][["cli_alert_success"]](
      "Cleaned up metadata cache"
    )
  }
  invisible(force)
}
